#!/bin/bash

installationPath=/usr/local
userName="sealionAgent"
groupName="sealionAgent"
untarFolderName="sealion-agent"
installationDirectory=$installationPath"/"$untarFolderName
tmpFilePath=/tmp/sealion-agent
tmpFileName=$tmpFilePath"/sealion-agent.tmp"

agentToken=`cat $tmpFileName`

if [ $? -ne 0 ] ; then
    echo "Sealion-Agent Error#400003: Error in reading agent token. terminating the process"
    exit 400003    
fi

echo "Sealion Agent: Extracting Files..."
    match=$(grep --text --line-number '^SEALION_TARFILE:$' $0 | cut -d ':' -f 1)
    tarFileStart=$((match +1))
    sudo tail -n +$tarFileStart $0 | tar -xzf - -C $installationPath --overwrite
    if [ $? -ne 0 ]; then
        echo "Sealion-Agent Error#400004: Exiting... Error while expanding files!!!"
        exit 400004
    fi
echo "Sealion Agent: Files Extracted Successfully"

rm -r $tmpFilePath
if [ $? -ne 0 ] ; then
    echo "Sealion-Agent Error#400006: Error in deleting temporary files"
fi

echo "Sealion Agent: Creating Sealion Agent's User..."
    sudo useradd -r -d $installationDirectory $userName
    tempVar=$?
    if [ $tempVar -ne 0 ] ; then
        if [ $tempVar -eq 9 ] ; then
            echo "Sealion-Agent Warning: Username 'sealionAgent' already exists, using same user"
        else
            echo "Sealion-Agent Error#400005: Can't create user!!!"
            sudo rm -r $installationDirectory
            exit 400005
        fi
    fi
echo "Sealion Agent: Sealion Agent's User creation successful"

echo "Sealion Agent: Starting agent..."
    cd $installationDirectory
    sudo echo $agentToken > etc/config/agent-config.json
    sudo mkdir -p var/dbs/
    sudo chown -R $userName:$userName $installationDirectory 
    sudo -u $userName ./bin/nodejs/bin/node index.js
echo "SealionAgent: Service is running, exiting installer"

exit 0
