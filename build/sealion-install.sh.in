#!/bin/bash

INSTALLATION_PATH=/usr/local
USER_NAME="sealion"
UNTAR_FOLDER_NAME="sealion-agent"
INSTALLATION_DIRECTORY=$INSTALLATION_PATH"/"$UNTAR_FOLDER_NAME
TMP_FILE_PATH=/tmp/sealion-agent
TMP_FILE_NAME=$TMP_FILE_PATH"/sealion-agent.tmp"

AGENT_TOKEN=`cat $TMP_FILE_NAME`

if [ $? -ne 0 ] ; then
    echo "Sealion-Agent Error#400003: Error in reading agent token. terminating the process" >&2
    exit 1    
fi

echo "Sealion Agent: Extracting Files..." >&1
    MATCH=$(grep --text --line-number '^SEALION_TARFILE:$' $0 | cut -d ':' -f 1)
    TAR_FILE_START=$((MATCH +1))
    sudo tail -n +$TAR_FILE_START $0 | tar -xzf - -C $INSTALLATION_PATH --overwrite
    if [ $? -ne 0 ]; then
        echo "Sealion-Agent Error#400004: Exiting... Error while expanding files!!!" >&2
        exit 1
    fi
echo "Sealion Agent: Files Extracted Successfully" >&1

cd $INSTALLATION_DIRECTORY
echo $AGENT_TOKEN > etc/config/agent-config.json
mkdir -p var/dbs
mkdir -p var/log
exit 0
