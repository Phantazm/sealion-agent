#! /bin/bash

USAGE="Usage: curl -k https://192.168.1.70/downloads/sealion.sh | bash /dev/stdin \n\t-o <Organisation Token> \n\t[-H <Hostname>] \n\t[-t <comma seperated list of tags without spaces>] \n\t [-h for help]"
OPTERR=0
LOCK_FILE=/usr/local/sealion-agent/var/sealion/sealion.pid
INIT_FILE=/etc/init.d/sealion
TMP_FILE_PATH=/tmp/sealion-agent

TMP_DATA_NAME=$TMP_FILE_PATH"/sealion-data.tmp"

INSTALLATION_DIRECTORY=/usr/local/sealion-agent/

USERNAME="sealion"
SYMLINK_PATHS=(K K S S S S K)
is_root=0

clean_up()
{
    for (( i = 0 ; i < $1 ; i++ )) 
    do
        sudo rm -f /etc/rc$i.d/${SYMLINK_PATHS[$i]}20sealion
    done
    sudo rm -rf $TEMP_PATH        
}


get_JSON_value()
{
    if [ $# -eq 0 ] ; then
        return 1
    fi 
    
    JSON="'$@'"
    
    version=`python -c "import json;obj=json.loads($JSON);print obj[\"agentVersion\"]"` 
    agent_token=`python -c "import json;obj=json.loads($JSON);print obj[\"agentToken\"]"`
    already_registered=`python -c "import json;obj=json.loads($JSON);print obj[\"alreadyRegistered\"]"`
    return 0
}

running=`pgrep sealion-node | wc -w`
if [ $running -gt 0 ] ; then
    echo "Sealion service already running. Stopping the service"
    $INIT_FILE stop
fi

while getopts a:o:c:v:hH: OPT ; do
    case "$OPT" in
        v)
            version=$OPTARG
        ;;
        a)
            agent_token=$OPTARG
        ;;
        H)
            host=$OPTARG
        ;;
        h)
            printf "$USAGE \n" >&1
            exit 0
        ;;
        o)
        if [ -z $org_token ] ; then
            org_token=$OPTARG
        else
            echo "Sealion-Agent Error: Organization token option is repeated. Quiting" >&2
            exit 127
        fi
        ;;
        c)
            tags=$OPTARG
        ;;
        \?)
            echo "Invalid argument -$OPTARG" >&2
            printf "$USAGE \n" >&2
            exit 126
        ;;
        :)
            echo "Option -$OPTARG requires an argument." >&2
            exit 125
        ;;
    esac
done

if [ -z $agent_token ] ; then

    if [ -z $org_token ] ; then
        echo "Sealion-Agent Error: No Organization token is supplied. Quiting" >&2
        exit 124
    fi

    if [ -z $host ] ; then
        host=$HOSTNAME  
    fi

    mkdir -p $TMP_FILE_PATH
    if [ $? -ne 0 ] ; then
        echo "Sealion-Agent Error#400001: Can't create temporary directory" >&2
        exit 1
    fi
    
    if [ -z $tags ] ; then
        return_code=`curl -k -s -w "%{http_code}" -H "Content-Type: application/json" -X POST -d "{\"orgToken\":\"$org_token\", \"name\":\"$host\"}" https://api.sealion.com/agents -o $TMP_DATA_NAME`
        if [ $? -ne 0 -o $return_code -ne 200 ] ; then
            echo "Sealion-Agent Error: Download/Installation failed" >&2
            exit 123
        fi     
    else
        tags=\"$tags\"
        tags=${tags//,/\",\"}
        return_code=`curl -k -s -w "%{http_code}" -H "Content-Type: application/json" -X POST -d "{\"orgToken\":\"$org_token\", \"name\":\"$host\", \"category\":[$tags]}" https://api.sealion.com/agents -o $TMP_DATA_NAME`
        if [ $? -ne 0 -o $return_code -ne 200 ] ; then
            echo "Sealion-Agent Error: Download/Installation failed"
            exit 123
        fi
    fi
    
    dataJSON=`cat $TMP_DATA_NAME`
    
    
    get_JSON_value $dataJSON
    if [ $? -ne 0 ] ; then
        echo "Sealion-Agent Error: Response parse error"    
        exit 121
    fi
    
    if [ -z $version ] ; then
        echo "Sealion-Agent Error: 'agent-version' not present in response. Please report the issue"
        exit 119
    fi    
    
    if [ -z $agent_token ] ; then
        echo "Sealion-Agent Error: 'agent-token' not present in response. Please report the issue"
        exit 120
    fi
    
    if [ -z $already_registered ] ; then
        echo "Sealion-Agent Error: 'already-registered' not present in response. Please report the issue"
    else
        if [ $already_registered -eq 1 ]; then
            echo "Sealion-Agent Warning: Agent may be already registered" >&1
        fi
    fi
    
    is_root=1    
        
    mkdir -p $INSTALLATION_DIRECTORY
    if [ $? -ne 0 ] ; then
        echo "Sealion-Agent Error#400005: Can't create directory!!!" >&2
    fi

    echo "Sealion Agent: Creating Sealion Agent's User..." >&1
    useradd -r -d $INSTALLATION_DIRECTORY $USERNAME 2> /dev/null
    tempVar=$?
    if [ $tempVar -ne 0 ] ; then
        if [ $tempVar -eq 9 ] ; then
            echo "Sealion-Agent Warning: Username 'sealion' already exists, using same user" >&1
        else
            echo "Sealion-Agent Error#400005: Can't create user!!!" >&2
            rm -r $INSTALLATION_DIRECTORY
            exit 1
        fi
    fi
    echo "Sealion Agent: Sealion Agent's User creation successful" >&1

else

    if [ -z $version ] ; then 
        echo "Sealion-Agent Error: Agent-version not found"
        exit 121
    fi

fi    

echo "Sealion Agent: Extracting Files..." >&1
    
    MATCH=$( grep --text --line-number '^SEALION_TARFILE:$' $0 | cut -d ':' -f 1 )
    TAR_FILE_START=$(( MATCH + 1 ))
    
    tail -n +$TAR_FILE_START $0 | tar -xzf - -C $INSTALLATION_DIRECTORY --overwrite
    
    if [ $? -ne 0 ] ; then
        echo "Sealion-Agent Error#400002: Installation failed" >&2
        if [ $is_root -eq 1 ] ; then
            userdel sealion
            rm -rf $INSTALLATION_DIRECTORY
            rm -rf $TMP_FILE_PATH
            if [ $? -ne 0 ] ; then
                echo "Sealion-Agent Error#400006: Error in deleting temporary files" >&2
            fi
        fi
        exit 1
    fi

echo "Sealion Agent: Files Extracted Successfully" >&1

cd $INSTALLATION_DIRECTORY

echo "{ \"agentToken\":\"$agent_token\" , \"agentVersion\":\"$version\" }" > etc/config/agent-config.json


if [ $is_root -eq 1 ] ; then
    chown -R $USERNAME:$USERNAME $INSTALLATION_DIRECTORY

    echo "Sealion Agent: Creating /etc/init.d/sealion" >&1
    cp -u /usr/local/sealion-agent/etc/sealion $INIT_FILE
    chmod +x $INIT_FILE

    chown $USERNAME:$USERNAME $INIT_FILE

    echo "Sealion Agent: Creating start/stop links for /etc/init.d/sealion" >&1
    
    for (( i = 0 ; i < 7 ; i++ )) 
    do
        ln -sf $INIT_FILE /etc/rc$i.d/${SYMLINK_PATHS[$i]}20sealion
        if [ $? -ne 0 ] ; then
            echo "Sealion-Agent: Unable to update init.d files. Quiting" >&2
            clean_up $i
            exit 1
        fi
        chown -h $USERNAME:$USERNAME /etc/rc$i.d/${SYMLINK_PATHS[$i]}20sealion
    done

else

    cat etc/sealion > $INIT_FILE

fi

rm -rf $TMP_FILE_PATH
if [ $? -ne 0 ] ; then
    echo "Sealion-Agent Error#400006: Error in deleting temporary files" >&2
fi

echo "Sealion Agent: Starting Agent..." >&1
$INIT_FILE start
if [ $? -ne 0 ] ; then
    echo "Sealion-Agent: Service can't be started due to errors" >&2
    exit 1
else
    echo "Sealion Agent: Service is running, exiting installer" >&1
    exit 0
fi
exit 0
